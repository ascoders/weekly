# 1. å¼•è¨€

å·¥å…·å‹æ–‡ç« è¦è·³è¯»ï¼Œè€Œæ–‡å­¦ç»å…¸å°±è¦åå¤ç ”è¯»ã€‚å¦‚æœè¯´ React `0.14` ç‰ˆæœ¬å¸¦æ¥çš„å„ç§ç”Ÿå‘½å‘¨æœŸå¯ä»¥ç±»æ¯”åˆ°å·¥å…·å‹æ–‡ç« ï¼Œé‚£ä¹ˆ `16.7` å¸¦æ¥çš„ Hooks å°±è¦åƒæ–‡å­¦ç»å…¸ä¸€æ ·åå¤ç ”è¯»ã€‚

Hooks API æ— è®ºä»ç®€æ´ç¨‹åº¦ï¼Œè¿˜æ˜¯ä½¿ç”¨æ·±åº¦è§’åº¦æ¥çœ‹ï¼Œéƒ½å¤§å¤§ä¼˜äºä¹‹å‰ç”Ÿå‘½å‘¨æœŸçš„ APIï¼Œæ‰€ä»¥å¿…é¡»åå¤ç†è§£ï¼Œåå¤å®è·µï¼Œå¦åˆ™åªèƒ½åœç•™åœ¨è¡¨é¢åŸåœ°è¸æ­¥ã€‚

ç›¸æ¯” `useState` æˆ–è€…è‡ªå®šä¹‰ Hooks è€Œè¨€ï¼Œæœ€æœ‰ç†è§£éš¾åº¦çš„æ˜¯ `useEffect` è¿™ä¸ªå·¥å…·ï¼Œå¸Œæœ›å€Ÿç€ [a-complete-guide-to-useeffect](https://overreacted.io/a-complete-guide-to-useeffect/) ä¸€æ–‡ï¼Œæ·±å…¥ç†è§£ `useEffect`ã€‚

> åŸæ–‡éå¸¸é•¿ï¼Œæ‰€ä»¥æ¦‚è¿°æ˜¯ç¬”è€…ç²¾ç®€åçš„ã€‚ä½œè€…æ˜¯ [Dan Abramov](https://mobile.twitter.com/dan_abramov)ï¼ŒReact æ ¸å¿ƒå¼€å‘è€…ã€‚

# 2. æ¦‚è¿°

**unLearning**ï¼Œä¹Ÿå°±æ˜¯å­¦ä¼šå¿˜è®°ã€‚**ä½ ä¹‹å‰çš„å­¦ä¹ ç»éªŒä¼šé˜»ç¢ä½ è¿›ä¸€æ­¥å­¦ä¹ ã€‚**

æƒ³è¦ç†è§£å¥½ `useEffect` å°±å¿…é¡»å…ˆæ·±å…¥ç†è§£ Function Component çš„æ¸²æŸ“æœºåˆ¶ï¼ŒFunction Component ä¸ Class Component åŠŸèƒ½ä¸Šçš„ä¸åŒåœ¨ä¸Šä¸€æœŸç²¾è¯» [ç²¾è¯»ã€ŠFunction VS Class ç»„ä»¶ã€‹](https://github.com/dt-fe/weekly/blob/master/95.%E7%B2%BE%E8%AF%BB%E3%80%8AFunction%20VS%20Class%20%E7%BB%84%E4%BB%B6%E3%80%8B.md) å·²ç»ä»‹ç»ï¼Œè€Œä»–ä»¬è¿˜å­˜åœ¨æ€ç»´ä¸Šçš„ä¸åŒï¼š

**Function Component æ˜¯æ›´å½»åº•çš„çŠ¶æ€é©±åŠ¨æŠ½è±¡ï¼Œç”šè‡³æ²¡æœ‰ Class Component ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œåªæœ‰ä¸€ä¸ªçŠ¶æ€ï¼Œè€Œ React è´Ÿè´£åŒæ­¥åˆ° DOMã€‚** è¿™æ˜¯ç†è§£ Function Component ä»¥åŠ `useEffect` çš„å…³é”®ï¼Œåé¢è¿˜ä¼šè¯¦ç»†ä»‹ç»ã€‚

> ç”±äºåŸæ–‡éå¸¸éå¸¸çš„é•¿ï¼Œæ‰€ä»¥ç¬”è€…ç²¾ç®€ä¸‹å†…å®¹å†é‡æ–°æ•´ç†ä¸€éã€‚åŸæ–‡éå¸¸é•¿çš„å¦ä¸€ä¸ªåŸå› æ˜¯é‡‡ç”¨äº†å¯å‘å¼æ€è€ƒä¸é€å±‚é€’è¿›çš„æ–¹å¼å†™ä½œï¼Œç¬”è€…æœ€å¤§ç¨‹åº¦ä¿ç•™è¿™ä¸ªæ€ç»´æ¡†æ¶ã€‚

## ä»å‡ ä¸ªç–‘é—®å¼€å§‹

å‡è®¾è¯»è€…æœ‰æ¯”è¾ƒä¸°å¯Œçš„å‰ç«¯ & React å¼€å‘ç»éªŒï¼Œå¹¶ä¸”å†™è¿‡ä¸€äº› [Hooks](https://reactjs.org/docs/hooks-intro.html)ã€‚é‚£ä¹ˆä½ ä¹Ÿè®¸è§‰å¾— Function Component å¾ˆå¥½ç”¨ï¼Œä½†ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œæ€»æœ‰ä¸€äº›ç–‘æƒ‘è¦ç»•åœ¨å¿ƒä¸­ï¼Œæ¯”å¦‚ï¼š

- ğŸ¤” å¦‚ä½•ç”¨ `useEffect` ä»£æ›¿ `componentDidMount`?
- ğŸ¤” å¦‚ä½•ç”¨ `useEffect` å–æ•°ï¼Ÿå‚æ•° `[]` ä»£è¡¨ä»€ä¹ˆï¼Ÿ
- ğŸ¤”`useEffect` çš„ä¾èµ–å¯ä»¥æ˜¯å‡½æ•°å—ï¼Ÿæ˜¯å“ªäº›å‡½æ•°ï¼Ÿ
- ğŸ¤” ä¸ºä½•æœ‰æ—¶å€™å–æ•°ä¼šè§¦å‘æ­»å¾ªç¯ï¼Ÿ
- ğŸ¤” ä¸ºä»€ä¹ˆæœ‰æ—¶å€™åœ¨ `useEffect` ä¸­æ‹¿åˆ°çš„ state æˆ– props æ˜¯æ—§çš„ï¼Ÿ

ç¬¬ä¸€ä¸ªé—®é¢˜å¯èƒ½å·²ç»è‡ªé—®è‡ªç­”è¿‡æ— æ•°æ¬¡äº†ï¼Œä½†ä¸‹æ¬¡å†™ä»£ç çš„æ—¶å€™è¿˜æ˜¯ä¼šå¿˜ã€‚ç¬”è€…ä¹Ÿä¸€æ ·ï¼Œè€Œä¸”åœ¨ä¸‰æœŸä¸åŒçš„ç²¾è¯»ä¸­éƒ½åˆ†åˆ«ä»‹ç»è¿‡è¿™ä¸ªé—®é¢˜ï¼š

- [ç²¾è¯»ã€ŠReact Hooksã€‹](https://github.com/dt-fe/weekly/blob/master/79.%E7%B2%BE%E8%AF%BB%E3%80%8AReact%20Hooks%E3%80%8B.md)
- [ç²¾è¯»ã€Šæ€ä¹ˆç”¨ React Hooks é€ è½®å­ã€‹](https://github.com/dt-fe/weekly/blob/master/80.%E7%B2%BE%E8%AF%BB%E3%80%8A%E6%80%8E%E4%B9%88%E7%94%A8%20React%20Hooks%20%E9%80%A0%E8%BD%AE%E5%AD%90%E3%80%8B.md)
- [ç²¾è¯»ã€ŠFunction VS Class ç»„ä»¶ã€‹](https://github.com/dt-fe/weekly/blob/master/95.%E7%B2%BE%E8%AF%BB%E3%80%8AFunction%20VS%20Class%20%E7%BB%84%E4%BB%B6%E3%80%8B.md)

ä½†ç¬¬äºŒå¤©å°±å¿˜è®°äº†ï¼Œå› ä¸º **ç”¨ Hooks å®ç°ç”Ÿå‘½å‘¨æœŸç¡®å®åˆ«æ‰­ã€‚** è®²çœŸï¼Œ**å¦‚æœæƒ³å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¯·ä½ å¿˜æ‰ Reactã€å¿˜æ‰ç”Ÿå‘½å‘¨æœŸï¼Œé‡æ–°ç†è§£ä¸€ä¸‹ Function Component çš„æ€ç»´æ–¹å¼å§ï¼**

> ä¸Šé¢ 5 ä¸ªé—®é¢˜çš„è§£ç­”å°±ä¸èµ˜è¿°äº†ï¼Œè¯»è€…å¦‚æœæœ‰ç–‘æƒ‘å¯ä»¥å» [åŸæ–‡ TLDR](https://overreacted.io/a-complete-guide-to-useeffect/#tldr) æŸ¥çœ‹ã€‚

è¦è¯´æ¸…æ¥š `useEffect`ï¼Œæœ€å¥½å…ˆä» Render æ¦‚å¿µå¼€å§‹ç†è§£ã€‚

## æ¯æ¬¡ Render éƒ½æœ‰è‡ªå·±çš„ Props ä¸ State

å¯ä»¥è®¤ä¸ºæ¯æ¬¡ Render çš„å†…å®¹éƒ½ä¼šå½¢æˆä¸€ä¸ªå¿«ç…§å¹¶ä¿ç•™ä¸‹æ¥ï¼Œå› æ­¤å½“çŠ¶æ€å˜æ›´è€Œ Rerender æ—¶ï¼Œå°±å½¢æˆäº† N ä¸ª Render çŠ¶æ€ï¼Œè€Œæ¯ä¸ª Render çŠ¶æ€éƒ½æ‹¥æœ‰è‡ªå·±å›ºå®šä¸å˜çš„ Props ä¸ Stateã€‚

çœ‹ä¸‹é¢çš„ `count`ï¼š

```jsx
function Counter() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  );
}
```

åœ¨æ¯æ¬¡ç‚¹å‡»æ—¶ï¼Œ`count` åªæ˜¯ä¸€ä¸ªä¸ä¼šå˜çš„å¸¸é‡ï¼Œè€Œä¸”ä¹Ÿä¸å­˜åœ¨åˆ©ç”¨ `Proxy` çš„åŒå‘ç»‘å®šï¼Œåªæ˜¯ä¸€ä¸ªå¸¸é‡å­˜åœ¨äºæ¯æ¬¡ Render ä¸­ã€‚

åˆå§‹çŠ¶æ€ä¸‹ `count` å€¼ä¸º `0`ï¼Œè€Œéšç€æŒ‰é’®è¢«ç‚¹å‡»ï¼Œåœ¨æ¯æ¬¡ Render è¿‡ç¨‹ä¸­ï¼Œ`count` çš„å€¼éƒ½ä¼šè¢«å›ºåŒ–ä¸º `1`ã€`2`ã€`3`ï¼š

```jsx
// During first render
function Counter() {
  const count = 0; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>;
  // ...
}

// After a click, our function is called again
function Counter() {
  const count = 1; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>;
  // ...
}

// After another click, our function is called again
function Counter() {
  const count = 2; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>;
  // ...
}
```

å…¶å®ä¸ä»…æ˜¯å¯¹è±¡ï¼Œå‡½æ•°åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶ä¹Ÿæ˜¯ç‹¬ç«‹çš„ã€‚è¿™å°±æ˜¯ **Capture Value** ç‰¹æ€§ï¼Œåé¢é‡åˆ°è¿™ç§æƒ…å†µå°±ä¸ä¼šä¸€ä¸€å±•å¼€ï¼Œåªæè¿°ä¸º â€œæ­¤å¤„æ‹¥æœ‰ Capture Value ç‰¹æ€§â€ã€‚

## æ¯æ¬¡ Render éƒ½æœ‰è‡ªå·±çš„äº‹ä»¶å¤„ç†

è§£é‡Šäº†ä¸ºä»€ä¹ˆä¸‹é¢çš„ä»£ç ä¼šè¾“å‡º `5` è€Œä¸æ˜¯ `3`:

```jsx
const App = () => {
  const [temp, setTemp] = React.useState(5);

  const log = () => {
    setTimeout(() => {
      console.log("3 ç§’å‰ temp = 5ï¼Œç°åœ¨ temp =", temp);
    }, 3000);
  };

  return (
    <div
      onClick={() => {
        log();
        setTemp(3);
        // 3 ç§’å‰ temp = 5ï¼Œç°åœ¨ temp = 5
      }}
    >
      xyz
    </div>
  );
};
```

åœ¨ `log` å‡½æ•°æ‰§è¡Œçš„é‚£ä¸ª Render è¿‡ç¨‹é‡Œï¼Œ`temp` çš„å€¼å¯ä»¥çœ‹ä½œå¸¸é‡ `5`ï¼Œ**æ‰§è¡Œ `setTemp(3)` æ—¶ä¼šäº¤ç”±ä¸€ä¸ªå…¨æ–°çš„ Render æ¸²æŸ“**ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ `log` å‡½æ•°ã€‚**è€Œ 3 ç§’åæ‰§è¡Œçš„å†…å®¹æ˜¯ç”± `temp` ä¸º `5` çš„é‚£ä¸ª Render å‘å‡ºçš„**ï¼Œæ‰€ä»¥ç»“æœè‡ªç„¶ä¸º `5`ã€‚

åŸå› å°±æ˜¯ `temp`ã€`log` éƒ½æ‹¥æœ‰ Capture Value ç‰¹æ€§ã€‚

## æ¯æ¬¡ Render éƒ½æœ‰è‡ªå·±çš„ Effects

`useEffect` ä¹Ÿä¸€æ ·å…·æœ‰ Capture Value çš„ç‰¹æ€§ã€‚

`useEffect` åœ¨å®é™… DOM æ¸²æŸ“å®Œæ¯•åæ‰§è¡Œï¼Œé‚£ `useEffect` æ‹¿åˆ°çš„å€¼ä¹Ÿéµå¾ª Capture Value çš„ç‰¹æ€§ï¼š

```jsx
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    document.title = `You clicked ${count} times`;
  });

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  );
}
```

ä¸Šé¢çš„ `useEffect` åœ¨æ¯æ¬¡ Render è¿‡ç¨‹ä¸­ï¼Œæ‹¿åˆ°çš„ `count` éƒ½æ˜¯å›ºåŒ–ä¸‹æ¥çš„å¸¸é‡ã€‚

## å¦‚ä½•ç»•è¿‡ Capture Value

åˆ©ç”¨ `useRef` å°±å¯ä»¥ç»•è¿‡ Capture Value çš„ç‰¹æ€§ã€‚**å¯ä»¥è®¤ä¸º `ref` åœ¨æ‰€æœ‰ Render è¿‡ç¨‹ä¸­ä¿æŒç€å”¯ä¸€å¼•ç”¨ï¼Œå› æ­¤æ‰€æœ‰å¯¹ `ref` çš„èµ‹å€¼æˆ–å–å€¼ï¼Œæ‹¿åˆ°çš„éƒ½åªæœ‰ä¸€ä¸ªæœ€ç»ˆçŠ¶æ€**ï¼Œè€Œä¸ä¼šåœ¨æ¯ä¸ª Render é—´å­˜åœ¨éš”ç¦»ã€‚

```jsx
function Example() {
  const [count, setCount] = useState(0);
  const latestCount = useRef(count);

  useEffect(() => {
    // Set the mutable latest value
    latestCount.current = count;
    setTimeout(() => {
      // Read the mutable latest value
      console.log(`You clicked ${latestCount.current} times`);
    }, 3000);
  });
  // ...
}
```

ä¹Ÿå¯ä»¥ç®€æ´çš„è®¤ä¸ºï¼Œ`ref` æ˜¯ Mutable çš„ï¼Œè€Œ `state` æ˜¯ Immutable çš„ã€‚

## å›æ”¶æœºåˆ¶

åœ¨ç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œé€šè¿‡ `useEffect` æ³¨å†Œçš„ç›‘å¬éœ€è¦è¢«é”€æ¯ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ `useEffect` çš„è¿”å›å€¼åšåˆ°ï¼š

```jsx
useEffect(() => {
  ChatAPI.subscribeToFriendStatus(props.id, handleStatusChange);
  return () => {
    ChatAPI.unsubscribeFromFriendStatus(props.id, handleStatusChange);
  };
});
```

åœ¨ç»„ä»¶è¢«é”€æ¯æ—¶ï¼Œä¼šæ‰§è¡Œè¿”å›å€¼å‡½æ•°å†…å›è°ƒå‡½æ•°ã€‚åŒæ ·ï¼Œç”±äº Capture Value ç‰¹æ€§ï¼Œæ¯æ¬¡ â€œæ³¨å†Œâ€ â€œå›æ”¶â€ æ‹¿åˆ°çš„éƒ½æ˜¯æˆå¯¹çš„å›ºå®šå€¼ã€‚

## ç”¨åŒæ­¥å–ä»£ â€œç”Ÿå‘½å‘¨æœŸâ€

Function Component ä¸å­˜åœ¨ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥ä¸è¦æŠŠ Class Component çš„ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µæ¬è¿‡æ¥è¯•å›¾å¯¹å·å…¥åº§ã€‚Function Component ä»…æè¿° UI çŠ¶æ€ï¼ŒReact ä¼šå°†å…¶åŒæ­¥åˆ° DOMï¼Œä»…æ­¤è€Œå·²ã€‚

æ—¢ç„¶æ˜¯çŠ¶æ€åŒæ­¥ï¼Œé‚£ä¹ˆæ¯æ¬¡æ¸²æŸ“çš„çŠ¶æ€éƒ½ä¼šå›ºåŒ–ä¸‹æ¥ï¼Œè¿™åŒ…æ‹¬ `state` `props` `useEffect` ä»¥åŠå†™åœ¨ Function Component ä¸­çš„æ‰€æœ‰å‡½æ•°ã€‚

ç„¶è€Œèˆå¼ƒäº†ç”Ÿå‘½å‘¨æœŸçš„åŒæ­¥ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‘Šè¯‰ React å¦‚ä½•æ¯”å¯¹ Effectã€‚

## å‘Šè¯‰ React å¦‚ä½•å¯¹æ¯” Effects

è™½ç„¶ React åœ¨ DOM æ¸²æŸ“æ—¶ä¼š diff å†…å®¹ï¼Œåªå¯¹æ”¹å˜éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸æ˜¯æ•´ä½“æ›¿æ¢ï¼Œä½†å´åšä¸åˆ°å¯¹ Effect çš„å¢é‡ä¿®æ”¹è¯†åˆ«ã€‚å› æ­¤éœ€è¦å¼€å‘è€…é€šè¿‡ `useEffect` çš„ç¬¬äºŒä¸ªå‚æ•°å‘Šè¯‰ React ç”¨åˆ°äº†å“ªäº›å¤–éƒ¨å˜é‡ï¼š

```jsx
useEffect(() => {
  document.title = "Hello, " + name;
}, [name]); // Our deps
```

ç›´åˆ° `name` æ”¹å˜æ—¶çš„ Rerenderï¼Œ`useEffect` æ‰ä¼šå†æ¬¡æ‰§è¡Œã€‚

ç„¶è€Œæ‰‹åŠ¨ç»´æŠ¤æ¯”è¾ƒéº»çƒ¦è€Œä¸”å¯èƒ½é—æ¼ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨ [eslint](https://github.com/facebook/react/issues/14920) æ’ä»¶è‡ªåŠ¨æç¤º + FIXï¼š

<img width=500 src="https://user-images.githubusercontent.com/810438/54288712-d3615a00-459f-11e9-82a6-904442995d2f.gif">

## ä¸è¦å¯¹ Dependencies æ’’è°

å¦‚æœä½ æ˜æ˜ä½¿ç”¨äº†æŸä¸ªå˜é‡ï¼Œå´æ²¡æœ‰ç”³æ˜åœ¨ä¾èµ–ä¸­ï¼Œä½ ç­‰äºå‘ React æ’’äº†è°ï¼Œåæœå°±æ˜¯ï¼Œå½“ä¾èµ–çš„å˜é‡æ”¹å˜æ—¶ï¼Œ`useEffect` ä¹Ÿä¸ä¼šå†æ¬¡æ‰§è¡Œï¼š

```jsx
useEffect(() => {
  document.title = "Hello, " + name;
}, []); // Wrong: name is missing in dep
```

è¿™çœ‹ä¸Šå»å¾ˆè ¢ï¼Œä½†çœ‹çœ‹å¦ä¸€ä¸ªä¾‹å­å‘¢ï¼Ÿ

```jsx
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const id = setInterval(() => {
      setCount(count + 1);
    }, 1000);
    return () => clearInterval(id);
  }, []);

  return <h1>{count}</h1>;
}
```

`setInterval` æˆ‘ä»¬åªæƒ³æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªä»¥ä¸ºèªæ˜çš„å‘ React æ’’äº†è°ï¼Œå°†ä¾èµ–å†™æˆ `[]`ã€‚

â€œç»„ä»¶åˆå§‹åŒ–æ‰§è¡Œä¸€æ¬¡ `setInterval`ï¼Œé”€æ¯æ—¶æ‰§è¡Œä¸€æ¬¡ `clearInterval`ï¼Œè¿™æ ·çš„ä»£ç ç¬¦åˆé¢„æœŸã€‚â€ ä½ å¿ƒé‡Œå¯èƒ½è¿™ä¹ˆæƒ³ã€‚

ä½†æ˜¯ä½ é”™äº†ï¼Œç”±äº useEffect ç¬¦åˆ Capture Value çš„ç‰¹æ€§ï¼Œæ‹¿åˆ°çš„ `count` å€¼æ°¸è¿œæ˜¯åˆå§‹åŒ–çš„ `0`ã€‚**ç›¸å½“äº `setInterval` æ°¸è¿œåœ¨ `count` ä¸º `0` çš„ Scope ä¸­æ‰§è¡Œï¼Œä½ åç»­çš„ `setCount` æ“ä½œå¹¶ä¸ä¼šäº§ç”Ÿä»»ä½•ä½œç”¨ã€‚**

## è¯šå®çš„ä»£ä»·

ç¬”è€…ç¨ç¨ä¿®æ”¹äº†ä¸€ä¸‹æ ‡é¢˜ï¼Œå› ä¸ºè¯šå®æ˜¯è¦ä»˜å‡ºä»£ä»·çš„ï¼š

```jsx
useEffect(() => {
  const id = setInterval(() => {
    setCount(count + 1);
  }, 1000);
  return () => clearInterval(id);
}, [count]);
```

ä½ è€å®å‘Šè¯‰ React â€œå˜¿ï¼Œç­‰ `count` å˜åŒ–åå†æ‰§è¡Œå§â€ï¼Œé‚£ä¹ˆä½ ä¼šå¾—åˆ°ä¸€ä¸ªå¥½æ¶ˆæ¯å’Œä¸¤ä¸ªåæ¶ˆæ¯ã€‚

å¥½æ¶ˆæ¯æ˜¯ï¼Œä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼Œæ‹¿åˆ°äº†æœ€æ–°çš„ `count`ã€‚

åæ¶ˆæ¯æœ‰ï¼š

1. è®¡æ—¶å™¨ä¸å‡†äº†ï¼Œå› ä¸ºæ¯æ¬¡ `count` å˜åŒ–æ—¶éƒ½ä¼šé”€æ¯å¹¶é‡æ–°è®¡æ—¶ã€‚
2. é¢‘ç¹ ç”Ÿæˆ/é”€æ¯ å®šæ—¶å™¨å¸¦æ¥äº†ä¸€å®šæ€§èƒ½è´Ÿæ‹…ã€‚

## æ€ä¹ˆæ—¢è¯šå®åˆé«˜æ•ˆå‘¢ï¼Ÿ

ä¸Šè¿°ä¾‹å­ä½¿ç”¨äº† `count`ï¼Œç„¶è€Œè¿™æ ·çš„ä»£ç å¾ˆåˆ«æ‰­ï¼Œ**å› ä¸ºä½ åœ¨ä¸€ä¸ªåªæƒ³æ‰§è¡Œä¸€æ¬¡çš„ Effect é‡Œä¾èµ–äº†å¤–éƒ¨å˜é‡ã€‚**

æ—¢ç„¶è¦è¯šå®ï¼Œé‚£åªå¥½ **æƒ³åŠæ³•ä¸ä¾èµ–å¤–éƒ¨å˜é‡**ï¼š

```jsx
useEffect(() => {
  const id = setInterval(() => {
    setCount(c => c + 1);
  }, 1000);
  return () => clearInterval(id);
}, []);
```

`setCount` è¿˜æœ‰ä¸€ç§å‡½æ•°å›è°ƒæ¨¡å¼ï¼Œä½ ä¸éœ€è¦å…³å¿ƒå½“å‰å€¼æ˜¯ä»€ä¹ˆï¼Œåªè¦å¯¹ â€œæ—§çš„å€¼â€ è¿›è¡Œä¿®æ”¹å³å¯ã€‚è¿™æ ·è™½ç„¶ä»£ç æ°¸è¿œè¿è¡Œåœ¨ç¬¬ä¸€æ¬¡ Render ä¸­ï¼Œä½†æ€»æ˜¯å¯ä»¥è®¿é—®åˆ°æœ€æ–°çš„ `state`ã€‚

## å°†æ›´æ–°ä¸åŠ¨ä½œè§£è€¦

ä½ å¯èƒ½å‘ç°äº†ï¼Œä¸Šé¢æŠ•æœºå–å·§çš„æ–¹å¼å¹¶æ²¡æœ‰å½»åº•è§£å†³æ‰€æœ‰åœºæ™¯çš„é—®é¢˜ï¼Œæ¯”å¦‚åŒæ—¶ä¾èµ–äº†ä¸¤ä¸ª `state` çš„æƒ…å†µï¼š

```jsx
useEffect(() => {
  const id = setInterval(() => {
    setCount(c => c + step);
  }, 1000);
  return () => clearInterval(id);
}, [step]);
```

ä½ ä¼šå‘ç°ä¸å¾—ä¸ä¾èµ– `step` è¿™ä¸ªå˜é‡ï¼Œæˆ‘ä»¬åˆå›åˆ°äº† â€œè¯šå®çš„ä»£ä»·â€ é‚£ä¸€ç« ã€‚å½“ç„¶ Dan ä¸€å®šä¼šç»™æˆ‘ä»¬è§£æ³•çš„ã€‚

åˆ©ç”¨ `useEffect` çš„å…„å¼Ÿ `useReducer` å‡½æ•°ï¼Œå°†æ›´æ–°ä¸åŠ¨ä½œè§£è€¦å°±å¯ä»¥äº†ï¼š

```jsx
const [state, dispatch] = useReducer(reducer, initialState);
const { count, step } = state;

useEffect(() => {
  const id = setInterval(() => {
    dispatch({ type: "tick" }); // Instead of setCount(c => c + step);
  }, 1000);
  return () => clearInterval(id);
}, [dispatch]);
```

è¿™å°±æ˜¯ä¸€ä¸ªå±€éƒ¨ â€œReduxâ€ï¼Œç”±äºæ›´æ–°å˜æˆäº† `dispatch({ type: "tick" })` **æ‰€ä»¥ä¸ç®¡æ›´æ–°æ—¶éœ€è¦ä¾èµ–å¤šå°‘å˜é‡ï¼Œåœ¨è°ƒç”¨æ›´æ–°çš„åŠ¨ä½œé‡Œéƒ½ä¸éœ€è¦ä¾èµ–ä»»ä½•å˜é‡ã€‚** å…·ä½“æ›´æ–°æ“ä½œåœ¨ `reducer` å‡½æ•°é‡Œå†™å°±å¯ä»¥äº†ã€‚[åœ¨çº¿ Demo](https://codesandbox.io/s/xzr480k0np)ã€‚

> Dan ä¹Ÿå°† `useReducer` æ¯”ä½œ Hooks çš„çš„é‡‘æ‰‹æŒ‡æ¨¡å¼ï¼Œå› ä¸ºè¿™å……åˆ†ç»•è¿‡äº† Diff æœºåˆ¶ï¼Œä¸è¿‡ç¡®å®èƒ½è§£å†³ç—›ç‚¹ï¼

## å°† Function æŒªåˆ° Effect é‡Œ

åœ¨ â€œå‘Šè¯‰ React å¦‚ä½•å¯¹æ¯” Diffâ€ ä¸€ç« ä»‹ç»äº†ä¾èµ–çš„é‡è¦æ€§ï¼Œä»¥åŠå¯¹ React è¦è¯šå®ã€‚é‚£ä¹ˆå¦‚æœå‡½æ•°å®šä¹‰ä¸åœ¨ `useEffect` å‡½æ•°ä½“å†…ï¼Œä¸ä»…å¯èƒ½ä¼šé—æ¼ä¾èµ–ï¼Œè€Œä¸” [eslint](https://github.com/facebook/react/issues/14920) æ’ä»¶ä¹Ÿæ— æ³•å¸®åŠ©ä½ è‡ªåŠ¨æ”¶é›†ä¾èµ–ã€‚

ä½ çš„ç›´è§‰ä¼šå‘Šè¯‰ä½ è¿™æ ·åšä¼šå¸¦æ¥æ›´å¤šéº»çƒ¦ï¼Œæ¯”å¦‚å¦‚ä½•å¤ç”¨å‡½æ•°ï¼Ÿæ˜¯çš„ï¼Œåªè¦ä¸ä¾èµ– Function Component å†…å˜é‡çš„å‡½æ•°éƒ½å¯ä»¥å®‰å…¨çš„æŠ½å‡ºå»ï¼š

```jsx
// âœ… Not affected by the data flow
function getFetchUrl(query) {
  return "https://hn.algolia.com/api/v1/search?query=" + query;
}
```

ä½†æ˜¯ä¾èµ–äº†å˜é‡çš„å‡½æ•°æ€ä¹ˆåŠï¼Ÿ

## å¦‚æœéè¦æŠŠ Function å†™åœ¨ Effect å¤–é¢å‘¢ï¼Ÿ

å¦‚æœéè¦è¿™ä¹ˆåšï¼Œå°±ç”¨ `useCallback` å§ï¼

```javascript
function Parent() {
  const [query, setQuery] = useState("react");

  // âœ… Preserves identity until query changes
  const fetchData = useCallback(() => {
    const url = "https://hn.algolia.com/api/v1/search?query=" + query;
    // ... Fetch data and return it ...
  }, [query]); // âœ… Callback deps are OK

  return <Child fetchData={fetchData} />;
}

function Child({ fetchData }) {
  let [data, setData] = useState(null);

  useEffect(() => {
    fetchData().then(setData);
  }, [fetchData]); // âœ… Effect deps are OK

  // ...
}
```

ç”±äºå‡½æ•°ä¹Ÿå…·æœ‰ Capture Value ç‰¹æ€§ï¼Œç»è¿‡ `useCallback` åŒ…è£…è¿‡çš„å‡½æ•°å¯ä»¥å½“ä½œæ™®é€šå˜é‡ä½œä¸º `useEffect` çš„ä¾èµ–ã€‚`useCallback` åšçš„äº‹æƒ…ï¼Œå°±æ˜¯åœ¨å…¶ä¾èµ–å˜åŒ–æ—¶ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ï¼Œè§¦å‘ `useEffect` çš„ä¾èµ–å˜åŒ–ï¼Œå¹¶æ¿€æ´»å…¶é‡æ–°æ‰§è¡Œã€‚

## useCallback å¸¦æ¥çš„å¥½å¤„

åœ¨ Class Component çš„ä»£ç é‡Œï¼Œå¦‚æœå¸Œæœ›å‚æ•°å˜åŒ–å°±é‡æ–°å–æ•°ï¼Œä½ ä¸èƒ½ç›´æ¥æ¯”å¯¹å–æ•°å‡½æ•°çš„ Diffï¼š

```jsx
componentDidUpdate(prevProps) {
  // ğŸ”´ This condition will never be true
  if (this.props.fetchData !== prevProps.fetchData) {
    this.props.fetchData();
  }
}
```

åä¹‹ï¼Œè¦æ¯”å¯¹çš„æ˜¯å–æ•°å‚æ•°æ˜¯å¦å˜åŒ–ï¼š

```jsx
componentDidUpdate(prevProps) {
  if (this.props.query !== prevProps.query) {
    this.props.fetchData();
  }
}
```

ä½†è¿™ç§ä»£ç ä¸å†…èšï¼Œä¸€æ—¦å–æ•°å‚æ•°å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šå¼•å‘å¤šå¤„ä»£ç çš„ç»´æŠ¤å±æœºã€‚

åè§‚ Function Component ä¸­åˆ©ç”¨ `useCallback` å°è£…çš„å–æ•°å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥ä½œä¸ºä¾èµ–ä¼ å…¥ `useEffect`ï¼Œ**`useEffect` åªè¦å…³å¿ƒå–æ•°å‡½æ•°æ˜¯å¦å˜åŒ–ï¼Œè€Œå–æ•°å‚æ•°çš„å˜åŒ–åœ¨ `useCallback` æ—¶å…³å¿ƒï¼Œå†é…åˆ [eslint](https://github.com/facebook/react/issues/14920) æ’ä»¶çš„æ‰«æï¼Œèƒ½åšåˆ° ä¾èµ–ä¸ä¸¢ã€é€»è¾‘å†…èšï¼Œä»è€Œå®¹æ˜“ç»´æŠ¤ã€‚**

## æ›´æ›´æ›´å†…èš

é™¤äº†å‡½æ•°ä¾èµ–é€»è¾‘å†…èšä¹‹å¤–ï¼Œæˆ‘ä»¬å†çœ‹çœ‹å–æ•°çš„å…¨è¿‡ç¨‹ï¼š

ä¸€ä¸ª Class Component çš„æ™®é€šå–æ•°è¦è€ƒè™‘è¿™äº›ç‚¹ï¼š

1. åœ¨ `didMount` åˆå§‹åŒ–å‘è¯·æ±‚ã€‚
2. åœ¨ `didUpdate` åˆ¤æ–­å–æ•°å‚æ•°æ˜¯å¦å˜åŒ–ï¼Œå˜åŒ–å°±è°ƒç”¨å–æ•°å‡½æ•°é‡æ–°å–æ•°ã€‚
3. åœ¨ `unmount` ç”Ÿå‘½å‘¨æœŸæ·»åŠ  flagï¼Œåœ¨ `didMount` `didUpdate` ä¸¤å¤„åšå…¼å®¹ï¼Œå½“ç»„ä»¶é”€æ¯æ—¶å–æ¶ˆå–æ•°ã€‚

ä½ ä¼šè§‰å¾—ä»£ç è·³æ¥è·³å»çš„ï¼Œä¸ä»…åŒæ—¶å…³å¿ƒå–æ•°å‡½æ•°ä¸å–æ•°å‚æ•°ï¼Œè¿˜è¦åœ¨ä¸åŒç”Ÿå‘½å‘¨æœŸé‡Œç»´æŠ¤å¤šå¥—é€»è¾‘ã€‚é‚£ä¹ˆæ¢æˆ Function Component çš„æ€ç»´æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

> ç¬”è€…åˆ©ç”¨ useCallback å¯¹åŸ Demo è¿›è¡Œäº†æ”¹é€ ã€‚

```jsx
function Article({ id }) {
  const [article, setArticle] = useState(null);

  // å‰¯ä½œç”¨ï¼Œåªå…³å¿ƒä¾èµ–äº†å–æ•°å‡½æ•°
  useEffect(() => {
    // didCancel èµ‹å€¼ä¸å˜åŒ–çš„ä½ç½®æ›´å†…èš
    let didCancel = false;

    async function fetchData() {
      const article = await API.fetchArticle(id);
      if (!didCancel) {
        setArticle(article);
      }
    }

    fetchData();

    return () => {
      didCancel = true;
    };
  }, [id]);

  // ...
}
```

å½“ä½ çœŸçš„ç†è§£äº† Function Component ç†å¿µåï¼Œå°±å¯ä»¥ç†è§£ Dan çš„è¿™å¥è¯ï¼šè™½ç„¶ `useEffect` å‰æœŸå­¦ä¹ æˆæœ¬æ›´é«˜ï¼Œä½†ä¸€æ—¦ä½ æ­£ç¡®ä½¿ç”¨äº†å®ƒï¼Œå°±èƒ½æ¯” Class Component æ›´å¥½çš„å¤„ç†è¾¹ç¼˜æƒ…å†µã€‚

`useEffect` åªæ˜¯åº•å±‚ APIï¼Œæœªæ¥ä¸šåŠ¡æ¥è§¦åˆ°çš„æ˜¯æ›´å¤šå°è£…åçš„ä¸Šå±‚ APIï¼Œæ¯”å¦‚ `useFetch` æˆ–è€… `useTheme`ï¼Œå®ƒä»¬ä¼šæ›´å¥½ç”¨ã€‚

# 3. ç²¾è¯»

[åŸæ–‡](https://overreacted.io/a-complete-guide-to-useeffect/)æœ‰ 9000+ å•è¯ï¼Œéå¸¸é•¿ã€‚ä½†åŒæ—¶ä¹Ÿé…åˆä¸€äº› GIF åŠ¨å›¾ç”ŸåŠ¨è§£é‡Šäº† Render æ‰§è¡ŒåŸç†ï¼Œå¦‚æœä½ æƒ³ç”¨å¥½ Function Component æˆ–è€… Hooksï¼Œè¿™ç¯‡æ–‡ç« å‡ ä¹æ˜¯å¿…è¯»çš„ï¼Œå› ä¸ºæ²¡æœ‰äººèƒ½çŒœåˆ°ä»€ä¹ˆæ˜¯ Capture Valueï¼Œç„¶è€Œä¸èƒ½ç†è§£è¿™ä¸ªæ¦‚å¿µï¼ŒFunction Component ä¹Ÿä¸èƒ½ç”¨çš„é¡ºæ‰‹ã€‚

é‡æ–°æ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« çš„æ€è·¯ï¼š

1. ä»ä»‹ç» Render å¼•å‡º Capture Value çš„ç‰¹æ€§ã€‚
2. æ‹“å±•åˆ° Function Component ä¸€åˆ‡å‡å¯ Captureï¼Œé™¤äº† Refã€‚
3. ä» Capture Value è§’åº¦ä»‹ç» useEffect çš„ APIã€‚
4. ä»‹ç»äº† Function Component åªå…³æ³¨æ¸²æŸ“çŠ¶æ€çš„äº‹å®ã€‚
5. å¼•å‘äº†å¦‚ä½•æé«˜ useEffect æ€§èƒ½çš„æ€è€ƒã€‚
6. ä»‹ç»äº†ä¸è¦å¯¹ Dependencies æ’’è°çš„åŸºæœ¬åŸåˆ™ã€‚
7. ä»ä¸å¾—ä¸æ’’è°çš„ç‰¹ä¾‹ä¸­ä»‹ç»äº†å¦‚ä½•ç”¨ Function Component æ€ç»´è§£å†³è¿™äº›é—®é¢˜ã€‚
8. å½“ä½ å­¦ä¼šç”¨ Function Component ç†å¿µæ€è€ƒæ—¶ï¼Œä½ é€æ¸å‘ç°å®ƒçš„ä¸€äº›ä¼˜åŠ¿ã€‚
9. æœ€åç‚¹å‡ºäº†é€»è¾‘å†…èšï¼Œé«˜é˜¶å°è£…è¿™ä¸¤å¤§ç‰¹ç‚¹ï¼Œè®©ä½ åŒæ—¶é¢†æ‚Ÿåˆ° Hooks çš„å¼ºå¤§ä¸ä¼˜é›…ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæ¯”å†™æ¡†æ¶æ›´é«˜çš„å¢ƒç•Œæ˜¯å‘ç°ä»£ç çš„ç¾æ„Ÿï¼Œæ¯”å¦‚ Hooks æœ¬æ˜¯ä¸ºå¢å¼º Function Component èƒ½åŠ›è€Œåˆ›é€ ï¼Œä½†åœ¨æŠ›å‡ºé—®é¢˜-è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä¸æ–­çœ‹åˆ°è§„åˆ™é™åˆ¶ï¼Œæ¢ä¸€ä¸ªè§’åº¦æ‰“ç ´å®ƒï¼Œæœ€åä½“ä¼šåˆ°æ•´ä½“çš„é€»è¾‘ä¹‹ç¾ã€‚

ä»è¿™ç¯‡æ–‡ç« ä¸­ä¹Ÿå¯ä»¥è¯»åˆ°å¦‚ä½•å¢å¼ºå­¦ä¹ èƒ½åŠ›ã€‚ä½œè€…å‘Šè¯‰æˆ‘ä»¬ï¼Œå­¦ä¼šå¿˜è®°å¯ä»¥æ›´å¥½çš„ç†è§£ã€‚æˆ‘ä»¬ä¸è¦æ‹¿ç”Ÿå‘½å‘¨æœŸçš„å›ºåŒ–æ€ç»´å¾€ Hooks ä¸Šå¥—ï¼Œå› ä¸ºé‚£ä¼šé˜»ç¢æˆ‘ä»¬ç†è§£ Hooks çš„ç†å¿µã€‚

å¦è¡¥å……ä¸€äº›é›¶ç¢çš„å†…å®¹ã€‚

## useEffect è¿˜æœ‰ä»€ä¹ˆä¼˜åŠ¿

`useEffect` åœ¨æ¸²æŸ“ç»“æŸæ—¶æ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“è¿›ç¨‹ï¼Œæ‰€ä»¥ä½¿ç”¨ Function Component å†™çš„é¡¹ç›®ä¸€èˆ¬éƒ½æ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚

è‡ªç„¶ç¬¦åˆ React Fiber çš„ç†å¿µï¼Œå› ä¸º Fiber ä¼šæ ¹æ®æƒ…å†µæš‚åœæˆ–æ’é˜Ÿæ‰§è¡Œä¸åŒç»„ä»¶çš„ Renderï¼Œå¦‚æœä»£ç éµå¾ªäº† Capture Value çš„ç‰¹æ€§ï¼Œåœ¨ Fiber ç¯å¢ƒä¸‹ä¼šä¿è¯å€¼çš„å®‰å…¨è®¿é—®ï¼ŒåŒæ—¶å¼±åŒ–ç”Ÿå‘½å‘¨æœŸä¹Ÿèƒ½è§£å†³ä¸­æ–­æ‰§è¡Œæ—¶å¸¦æ¥çš„é—®é¢˜ã€‚

`useEffect` ä¸ä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶æ‰§è¡Œã€‚

ç”±äºåœ¨ DOM æ‰§è¡Œå®Œæ¯•åæ‰æ‰§è¡Œï¼Œæ‰€ä»¥èƒ½ä¿è¯æ‹¿åˆ°çŠ¶æ€ç”Ÿæ•ˆåçš„ DOM å±æ€§ã€‚

# 4. æ€»ç»“

æœ€åï¼Œæä¸¤ä¸ªæœ€é‡è¦çš„ç‚¹ï¼Œæ¥æ£€éªŒä½ æœ‰æ²¡æœ‰è¯»æ‡‚è¿™ç¯‡æ–‡ç« ï¼š

1. Capture Value ç‰¹æ€§ã€‚
2. ä¸€è‡´æ€§ã€‚**å°†æ³¨æ„æ”¾åœ¨ä¾èµ–ä¸Šï¼ˆ`useEffect` çš„ç¬¬äºŒä¸ªå‚æ•° `[]`ï¼‰ï¼Œè€Œä¸æ˜¯å…³æ³¨ä½•æ—¶è§¦å‘ã€‚**

ä½ å¯¹ â€œä¸€è‡´æ€§â€ æœ‰å“ªäº›æ›´æ·±çš„è§£è¯»å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€å›å¤ã€‚

> è®¨è®ºåœ°å€æ˜¯ï¼š[ç²¾è¯»ã€ŠuseEffect å®Œå…¨æŒ‡å—ã€‹ Â· Issue #138 Â· dt-fe/weekly](https://github.com/dt-fe/weekly/issues/138)

**å¦‚æœä½ æƒ³å‚ä¸è®¨è®ºï¼Œè¯· [ç‚¹å‡»è¿™é‡Œ](https://github.com/dt-fe/weekly)ï¼Œæ¯å‘¨éƒ½æœ‰æ–°çš„ä¸»é¢˜ï¼Œå‘¨æœ«æˆ–å‘¨ä¸€å‘å¸ƒã€‚å‰ç«¯ç²¾è¯» - å¸®ä½ ç­›é€‰é è°±çš„å†…å®¹ã€‚**

> å…³æ³¨ **å‰ç«¯ç²¾è¯»å¾®ä¿¡å…¬ä¼—å·**

<img width=200 src="https://img.alicdn.com/tfs/TB165W0MCzqK1RjSZFLXXcn2XXa-258-258.jpg">

**special Sponsors**

- [DevOps å…¨æµç¨‹å¹³å°](https://e.coding.net/?utm_source=weekly)

> ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²åï¼ˆ[åˆ›æ„å…±äº« 3.0 è®¸å¯è¯](https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh)ï¼‰
