# 1. å¼•è¨€

è¯»äº† [ç²¾è¯»ã€ŠuseEffect å®Œå…¨æŒ‡å—ã€‹](https://github.com/dt-fe/weekly/blob/master/96.%E7%B2%BE%E8%AF%BB%E3%80%8AuseEffect%20%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E3%80%8B.md) ä¹‹åï¼Œæ˜¯ä¸æ˜¯å¯¹ Function Component çš„ç†è§£åˆåŠ æ·±äº†ä¸€äº›å‘¢ï¼Ÿ

è¿™æ¬¡é€šè¿‡ [Writing Resilient Components](https://overreacted.io/writing-resilient-components/) ä¸€æ–‡ï¼Œäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯æœ‰å¼¹æ€§çš„ç»„ä»¶ï¼Œä»¥åŠä¸ºä»€ä¹ˆ Function Component å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

# 2. æ¦‚è¿°

ç›¸æ¯”ä»£ç çš„ Lint æˆ–è€… Prettierï¼Œæˆ–è®¸æˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨ä»£ç æ˜¯å¦å…·æœ‰å¼¹æ€§ã€‚

[Dan](https://mobile.twitter.com/dan_abramov) æ€»ç»“äº†å¼¹æ€§ç»„ä»¶å…·æœ‰çš„å››ä¸ªç‰¹å¾ï¼š

1. **ä¸è¦é˜»å¡æ•°æ®æµã€‚**
2. **æ—¶åˆ»å‡†å¤‡å¥½æ¸²æŸ“ã€‚**
3. **ä¸è¦æœ‰å•ä¾‹ç»„ä»¶ã€‚**
4. **éš”ç¦»æœ¬åœ°çŠ¶æ€ã€‚**

ä»¥ä¸Šè§„åˆ™ä¸ä»…é€‚ç”¨äº Reactï¼Œå®ƒé€‚ç”¨äºæ‰€æœ‰ UI ç»„ä»¶ã€‚

## ä¸è¦é˜»å¡æ¸²æŸ“çš„æ•°æ®æµ

ä¸é˜»å¡æ•°æ®æµçš„æ„æ€ï¼Œå°±æ˜¯ **ä¸è¦å°†æ¥æ”¶åˆ°çš„å‚æ•°æœ¬åœ°åŒ–ï¼Œ** æˆ–è€… **ä½¿ç»„ä»¶å®Œå…¨å—æ§**ã€‚

åœ¨ Class Component è¯­æ³•ä¸‹ï¼Œ**ç”±äºæœ‰ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œåœ¨æŸä¸ªç”Ÿå‘½å‘¨æœŸå°† `props` å­˜å‚¨åˆ° `state` çš„æ–¹å¼å±¡è§ä¸é²œã€‚** ç„¶è€Œä¸€æ—¦å°† `props` å›ºåŒ–åˆ° `state`ï¼Œç»„ä»¶å°±ä¸å—æ§äº†ï¼š

```jsx
class Button extends React.Component {
  state = {
    color: this.props.color
  };
  render() {
    const { color } = this.state; // ğŸ”´ `color` is stale!
    return <button className={"Button-" + color}>{this.props.children}</button>;
  }
}
```

å½“ç»„ä»¶å†æ¬¡åˆ·æ–°æ—¶ï¼Œ`props.color` å˜åŒ–äº†ï¼Œä½† `state.color` ä¸ä¼šå˜ï¼Œè¿™ç§æƒ…å†µå°±é˜»å¡äº†æ•°æ®æµï¼Œå°ä¼™ä¼´ä»¬å¯èƒ½ä¼šåæ§½ç»„ä»¶æœ‰ BUGã€‚è¿™æ—¶å€™å¦‚æœä½ å°è¯•é€šè¿‡å…¶ä»–ç”Ÿå‘½å‘¨æœŸï¼ˆ`componentWillReceiveProps` æˆ– `componentDidUpdate`ï¼‰å»ä¿®å¤ï¼Œä»£ç ä¼šå˜å¾—éš¾ä»¥ç®¡ç†ã€‚

ç„¶è€Œ Function Component æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œ**æ‰€ä»¥æ²¡æœ‰å¿…é¡»è¦å°† `props` å­˜å‚¨åˆ° `state`**ï¼Œç›´æ¥æ¸²æŸ“å³å¯ï¼š

```jsx
function Button({ color, children }) {
  return (
    // âœ… `color` is always fresh!
    <button className={"Button-" + color}>{children}</button>
  );
}
```

å¦‚æœéœ€è¦å¯¹ `props` è¿›è¡ŒåŠ å·¥ï¼Œå¯ä»¥åˆ©ç”¨ `useMemo` å¯¹åŠ å·¥è¿‡ç¨‹è¿›è¡Œç¼“å­˜ï¼Œä»…å½“ä¾èµ–å˜åŒ–æ—¶æ‰é‡æ–°æ‰§è¡Œï¼š

```jsx
const textColor = useMemo(
  () => slowlyCalculateTextColor(color),
  [color] // âœ… Donâ€™t recalculate until `color` changes
);
```

## ä¸è¦é˜»å¡å‰¯ä½œç”¨çš„æ•°æ®æµ

å‘è¯·æ±‚å°±æ˜¯ä¸€ç§å‰¯ä½œç”¨ï¼Œå¦‚æœåœ¨ä¸€ä¸ªç»„ä»¶å†…å‘è¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨å–æ•°å‚æ•°å˜åŒ–æ—¶ï¼Œæœ€å¥½èƒ½é‡æ–°å–æ•°ã€‚

```jsx
class SearchResults extends React.Component {
  state = {
    data: null
  };
  componentDidMount() {
    this.fetchResults();
  }
  componentDidUpdate(prevProps) {
    if (prevProps.query !== this.props.query) {
      // âœ… Refetch on change
      this.fetchResults();
    }
  }
  fetchResults() {
    const url = this.getFetchUrl();
    // Do the fetching...
  }
  getFetchUrl() {
    return "http://myapi/results?query" + this.props.query; // âœ… Updates are handled
  }
  render() {
    // ...
  }
}
```

å¦‚æœç”¨ Class Component çš„æ–¹å¼å®ç°ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯·æ±‚å‡½æ•° `getFetchUrl` æŠ½å‡ºæ¥ï¼Œå¹¶ä¸”åœ¨ `componentDidMount` ä¸ `componentDidUpdate` æ—¶åŒæ—¶è°ƒç”¨å®ƒï¼Œè¿˜è¦æ³¨æ„ `componentDidUpdate` æ—¶å¦‚æœå–æ•°å‚æ•° `state.query` æ²¡æœ‰å˜åŒ–åˆ™ä¸æ‰§è¡Œ `getFetchUrl`ã€‚

è¿™æ ·çš„ç»´æŠ¤ä½“éªŒå¾ˆç³Ÿç³•ï¼Œå¦‚æœå–æ•°å‚æ•°å¢åŠ äº† `state.currentPage`ï¼Œä½ å¾ˆå¯èƒ½åœ¨ `componentDidUpdate` ä¸­æ¼æ‰å¯¹ `state.currentPage` çš„åˆ¤æ–­ã€‚

å¦‚æœä½¿ç”¨ Function Componentï¼Œå¯ä»¥é€šè¿‡ `useCallback` å°†æ•´ä¸ªå–æ•°è¿‡ç¨‹ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼š

> åŸæ–‡æ²¡æœ‰ä½¿ç”¨ `useCallback`ï¼Œç¬”è€…è¿›è¡Œäº†åŠ å·¥ã€‚

```jsx
function SearchResults({ query }) {
  const [data, setData] = useState(null);
  const [currentPage, setCurrentPage] = useState(0);

  const getFetchUrl = useCallback(() => {
    return "http://myapi/results?query=" + query + "&page=" + currentPage;
  }, [currentPage, query]);

  useEffect(() => {
    const url = getFetchUrl();
    // Do the fetching...
  }, [getFetchUrl]); // âœ… Refetch on change

  // ...
}
```

Function Component å¯¹ `props` ä¸ `state` çš„æ•°æ®éƒ½ä¸€è§†åŒä»ï¼Œä¸”å¯ä»¥å°†å–æ•°é€»è¾‘ä¸ â€œæ›´æ–°åˆ¤æ–­â€ é€šè¿‡ `useCallback` å®Œå…¨å°è£…åœ¨ä¸€ä¸ªå‡½æ•°å†…ï¼Œå†å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºæ•´ä½“ä¾èµ–é¡¹æ·»åŠ åˆ° `useEffect`ï¼Œå¦‚æœæœªæ¥å†æ–°å¢ä¸€ä¸ªå‚æ•°ï¼Œåªè¦ä¿®æ”¹ `getFetchUrl` è¿™ä¸ªå‡½æ•°å³å¯ï¼Œè€Œä¸”è¿˜å¯ä»¥é€šè¿‡ `eslint-plugin-react-hooks` æ’ä»¶é™æ€åˆ†ææ˜¯å¦é—æ¼äº†ä¾èµ–é¡¹ã€‚

Function Component ä¸ä½†å°†ä¾èµ–é¡¹èšåˆèµ·æ¥ï¼Œè¿˜è§£å†³äº† Class Component åˆ†æ•£åœ¨å¤šå¤„ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°åˆ¤æ–­ï¼Œå¼•å‘çš„æ— æ³•é™æ€åˆ†æä¾èµ–çš„é—®é¢˜ã€‚

## ä¸è¦å› ä¸ºæ€§èƒ½ä¼˜åŒ–è€Œé˜»å¡æ•°æ®æµ

ç›¸æ¯” `PureComponent` ä¸ `React.memo`ï¼Œæ‰‹åŠ¨è¿›è¡Œæ¯”è¾ƒä¼˜åŒ–æ˜¯ä¸å¤ªå®‰å…¨çš„ï¼Œæ¯”å¦‚ä½ å¯èƒ½ä¼šå¿˜è®°å¯¹å‡½æ•°è¿›è¡Œå¯¹æ¯”ï¼š

```jsx
class Button extends React.Component {
  shouldComponentUpdate(prevProps) {
    // ğŸ”´ Doesn't compare this.props.onClick
    return this.props.color !== prevProps.color;
  }
  render() {
    const onClick = this.props.onClick; // ğŸ”´ Doesn't reflect updates
    const textColor = slowlyCalculateTextColor(this.props.color);
    return (
      <button
        onClick={onClick}
        className={"Button-" + this.props.color + " Button-text-" + textColor}
      >
        {this.props.children}
      </button>
    );
  }
}
```

ä¸Šé¢çš„ä»£ç æ‰‹åŠ¨è¿›è¡Œäº† `shouldComponentUpdate` å¯¹æ¯”ä¼˜åŒ–ï¼Œä½†æ˜¯å¿½ç•¥äº†å¯¹å‡½æ•°å‚æ•° `onClick` çš„å¯¹æ¯”ï¼Œå› æ­¤è™½ç„¶å¤§éƒ¨åˆ†æ—¶é—´ `onClick` ç¡®å®æ²¡æœ‰å˜åŒ–ï¼Œå› æ­¤ä»£ç ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆ bugï¼š

```jsx
class MyForm extends React.Component {
  handleClick = () => {
    // âœ… Always the same function
    // Do something
  };
  render() {
    return (
      <>
        <h1>Hello!</h1>
        <Button color="green" onClick={this.handleClick}>
          Press me
        </Button>
      </>
    );
  }
}
```

ä½†æ˜¯ä¸€æ—¦æ¢ä¸€ç§æ–¹å¼å®ç° `onClick`ï¼Œæƒ…å†µå°±ä¸ä¸€æ ·äº†ï¼Œæ¯”å¦‚ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š

```jsx
class MyForm extends React.Component {
  state = {
    isEnabled: true
  };
  handleClick = () => {
    this.setState({ isEnabled: false });
    // Do something
  };
  render() {
    return (
      <>
        <h1>Hello!</h1>
        <Button
          color="green"
          onClick={
            // ğŸ”´ Button ignores updates to the onClick prop
            this.state.isEnabled ? this.handleClick : null
          }
        >
          Press me
        </Button>
      </>
    );
  }
}
```

`onClick` éšæœºåœ¨ `null` ä¸ `this.handleClick` ä¹‹é—´åˆ‡æ¢ã€‚

```jsx
drafts.map(draft => (
  <Button
    color="blue"
    key={draft.id}
    onClick={
      // ğŸ”´ Button ignores updates to the onClick prop
      this.handlePublish.bind(this, draft.content)
    }
  >
    Publish
  </Button>
));
```

å¦‚æœ `draft.content` å˜åŒ–äº†ï¼Œåˆ™ `onClick` å‡½æ•°å˜åŒ–ã€‚

ä¹Ÿå°±æ˜¯å¦‚æœå­ç»„ä»¶è¿›è¡Œæ‰‹åŠ¨ä¼˜åŒ–æ—¶ï¼Œå¦‚æœæ¼äº†å¯¹å‡½æ•°çš„å¯¹æ¯”ï¼Œå¾ˆæœ‰å¯èƒ½æ‰§è¡Œåˆ°æ—§çš„å‡½æ•°å¯¼è‡´é”™è¯¯çš„é€»è¾‘ã€‚

æ‰€ä»¥å°½é‡ä¸è¦è‡ªå·±è¿›è¡Œä¼˜åŒ–ï¼ŒåŒæ—¶åœ¨ Function Component ç¯å¢ƒä¸‹ï¼Œåœ¨å†…éƒ¨ç”³æ˜çš„å‡½æ•°æ¯æ¬¡éƒ½æœ‰ä¸åŒçš„å¼•ç”¨ï¼Œå› æ­¤ä¾¿äºå‘ç°é€»è¾‘ BUGï¼ŒåŒæ—¶åˆ©ç”¨ `useCallback` ä¸ `useContext` æœ‰åŠ©äºè§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## æ—¶åˆ»å‡†å¤‡æ¸²æŸ“

ç¡®ä¿ä½ çš„ç»„ä»¶å¯ä»¥éšæ—¶é‡æ¸²æŸ“ï¼Œä¸”ä¸ä¼šå¯¼è‡´å†…éƒ¨çŠ¶æ€ç®¡ç†å‡ºç° BUGã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹å…¶å®æŒºéš¾çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªå¤æ‚ç»„ä»¶ï¼Œå¦‚æœæ¥æ”¶äº†ä¸€ä¸ªçŠ¶æ€ä½œä¸ºèµ·ç‚¹ï¼Œä¹‹åçš„ä»£ç åŸºäºè¿™ä¸ªèµ·ç‚¹æ´¾ç”Ÿäº†è®¸å¤šå†…éƒ¨çŠ¶æ€ï¼ŒæŸä¸ªæ—¶åˆ»æ”¹å˜äº†è¿™ä¸ªèµ·å§‹å€¼ï¼Œç»„ä»¶è¿˜èƒ½æ­£å¸¸è¿è¡Œå—ï¼Ÿ

æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š

```jsx
// ğŸ¤” Should prevent unnecessary re-renders... right?
class TextInput extends React.PureComponent {
  state = {
    value: ""
  };
  // ğŸ”´ Resets local state on every parent render
  componentWillReceiveProps(nextProps) {
    this.setState({ value: nextProps.value });
  }
  handleChange = e => {
    this.setState({ value: e.target.value });
  };
  render() {
    return <input value={this.state.value} onChange={this.handleChange} />;
  }
}
```

`componentWillReceiveProps` æ ‡è¯†äº†æ¯æ¬¡ç»„ä»¶æ¥æ”¶åˆ°æ–°çš„ `props`ï¼Œéƒ½ä¼šå°† `props.value` åŒæ­¥åˆ° `state.value`ã€‚è¿™å°±æ˜¯ä¸€ç§æ´¾ç”Ÿ `state`ï¼Œè™½ç„¶çœ‹ä¸Šå»å¯ä»¥åšåˆ°ä¼˜é›…æ‰¿æ¥ `props` çš„å˜åŒ–ï¼Œä½† **çˆ¶å…ƒç´ å› ä¸ºå…¶ä»–åŸå› çš„ rerender å°±ä¼šå¯¼è‡´ `state.value` éæ­£å¸¸é‡ç½®ï¼Œæ¯”å¦‚çˆ¶å…ƒç´ çš„ `forceUpdate`ã€‚**

å½“ç„¶å¯ä»¥é€šè¿‡ **ä¸è¦é˜»å¡æ¸²æŸ“çš„æ•°æ®æµ** ä¸€èŠ‚æ‰€è¯´çš„æ–¹å¼ï¼Œæ¯”å¦‚ `PureComponent`, `shouldComponentUpdate`, `React.memo` æ¥åšæ€§èƒ½ä¼˜åŒ–ï¼ˆå½“ `props.value` æ²¡æœ‰å˜åŒ–æ—¶å°±ä¸ä¼šé‡ç½® `state.value`ï¼‰ï¼Œä½†è¿™æ ·çš„ä»£ç ä¾ç„¶æ˜¯è„†å¼±çš„ã€‚

å¥å£®çš„ä»£ç ä¸ä¼šå› ä¸ºåˆ é™¤äº†æŸé¡¹ä¼˜åŒ–å°±å‡ºç° BUGï¼Œä¸è¦ä½¿ç”¨æ´¾ç”Ÿ `state` å°±èƒ½é¿å…æ­¤é—®é¢˜ã€‚

> ç¬”è€…è¡¥å……ï¼šè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯ï¼Œ1. å¦‚æœç»„ä»¶ä¾èµ–äº† `props.value`ï¼Œå°±ä¸éœ€è¦ä½¿ç”¨ `state.value`ï¼Œå®Œå…¨åšæˆ **å—æ§ç»„ä»¶**ã€‚2. å¦‚æœå¿…é¡»æœ‰ `state.value`ï¼Œé‚£å°±åšæˆå†…éƒ¨çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ä¸è¦ä»å¤–éƒ¨æ¥æ”¶ `props.value`ã€‚æ€»ä¹‹é¿å…å†™ â€œä»‹äºå—æ§ä¸éå—æ§ä¹‹é—´çš„ç»„ä»¶â€ã€‚

è¡¥å……ä¸€ä¸‹ï¼Œå¦‚æœåšæˆäº†éå—æ§ç»„ä»¶ï¼Œå´æƒ³é‡ç½®åˆå§‹å€¼ï¼Œé‚£ä¹ˆåœ¨çˆ¶çº§è°ƒç”¨å¤„åŠ ä¸Š `key` æ¥è§£å†³ï¼š

```jsx
<EmailInput defaultEmail={this.props.user.email} key={this.props.user.id} />
```

å¦å¤–ä¹Ÿå¯ä»¥é€šè¿‡ `ref` è§£å†³ï¼Œè®©å­å…ƒç´ æä¾›ä¸€ä¸ª `reset` å‡½æ•°ï¼Œä¸è¿‡ä¸æ¨èä½¿ç”¨ `ref`ã€‚

## ä¸è¦æœ‰å•ä¾‹ç»„ä»¶

ä¸€ä¸ªæœ‰å¼¹æ€§çš„åº”ç”¨ï¼Œåº”è¯¥èƒ½é€šè¿‡ä¸‹é¢è€ƒéªŒï¼š

```jsx
ReactDOM.render(
  <>
    <MyApp />
    <MyApp />
  </>,
  document.getElementById("root")
);
```

å°†æ•´ä¸ªåº”ç”¨æ¸²æŸ“ä¸¤éï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å„è‡ªæ­£ç¡®è¿ä½œï¼Ÿ

é™¤äº†ç»„ä»¶æœ¬åœ°çŠ¶æ€ç”±æœ¬åœ°ç»´æŠ¤å¤–ï¼Œå…·æœ‰å¼¹æ€§çš„ç»„ä»¶ä¸åº”è¯¥å› ä¸ºå…¶ä»–å®ä¾‹è°ƒç”¨äº†æŸäº›å‡½æ•°ï¼Œè€Œ â€œæ°¸è¿œé”™è¿‡äº†æŸäº›çŠ¶æ€æˆ–åŠŸèƒ½â€ã€‚

ç¬”è€…è¡¥å……ï¼šä¸€ä¸ªå±é™©çš„ç»„ä»¶ä¸€èˆ¬æ˜¯è¿™ä¹ˆæ€è€ƒçš„ï¼šæ²¡æœ‰äººä¼šéšæ„ç ´åæ•°æ®æµï¼Œå› æ­¤åªè¦åœ¨ `didMount` ä¸ `unMount` æ—¶åšå¥½æ•°æ®åˆå§‹åŒ–å’Œé”€æ¯å°±è¡Œäº†ã€‚

é‚£ä¹ˆå½“å¦ä¸€ä¸ªå®ä¾‹è¿›è¡Œé”€æ¯æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šç ´åè¿™ä¸ªå®ä¾‹çš„ä¸­é—´çŠ¶æ€ã€‚ä¸€ä¸ªå…·æœ‰å¼¹æ€§çš„ç»„ä»¶åº”è¯¥èƒ½ **éšæ—¶å“åº”** çŠ¶æ€çš„å˜åŒ–ï¼Œæ²¡æœ‰ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µçš„ Function Component å¤„ç†èµ·æ¥æ˜¾ç„¶æ›´å¾—å¿ƒåº”æ‰‹ã€‚

## éš”ç¦»æœ¬åœ°çŠ¶æ€

**å¾ˆå¤šæ—¶å€™éš¾ä»¥åˆ¤æ–­æ•°æ®å±äºç»„ä»¶çš„æœ¬åœ°çŠ¶æ€è¿˜æ˜¯å…¨å±€çŠ¶æ€ã€‚**

æ–‡ç« æä¾›äº†ä¸€ä¸ªåˆ¤æ–­æ–¹æ³•ï¼š**â€œæƒ³è±¡è¿™ä¸ªç»„ä»¶åŒæ—¶æ¸²æŸ“äº†ä¸¤ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªæ•°æ®ä¼šåŒæ—¶å½±å“è¿™ä¸¤ä¸ªå®ä¾‹å—ï¼Ÿå¦‚æœç­”æ¡ˆæ˜¯ ä¸ä¼šï¼Œé‚£è¿™ä¸ªæ•°æ®å°±é€‚åˆä½œä¸ºæœ¬åœ°çŠ¶æ€â€ã€‚**

å°¤å…¶åœ¨å†™ä¸šåŠ¡ç»„ä»¶æ—¶ï¼Œå®¹æ˜“å°†ä¸šåŠ¡æ•°æ®ä¸ç»„ä»¶æœ¬èº«çŠ¶æ€æ•°æ®æ··æ·†ã€‚

æ ¹æ®ç¬”è€…çš„ç»éªŒï¼Œ**ä»ä¸Šå±‚ä¸šåŠ¡åˆ°åº•å±‚é€šç”¨ç»„ä»¶ä¹‹é—´ï¼Œæœ¬åœ°çŠ¶æ€æ•°é‡æ˜¯é€’å¢çš„ï¼š**

```plain
ä¸šåŠ¡
  -> å…¨å±€æ•°æ®æµ
    -> é¡µé¢ï¼ˆå®Œå…¨ä¾èµ–å…¨å±€æ•°æ®æµï¼Œå‡ ä¹æ²¡æœ‰è‡ªå·±çš„çŠ¶æ€ï¼‰
      -> ä¸šåŠ¡ç»„ä»¶ï¼ˆä»é¡µé¢æˆ–å…¨å±€æ•°æ®æµç»§æ‰¿æ•°æ®ï¼Œå¾ˆå°‘æœ‰è‡ªå·±çŠ¶æ€ï¼‰
        -> é€šç”¨ç»„ä»¶ï¼ˆå®Œå…¨å—æ§ï¼Œæ¯”å¦‚ inputï¼›æˆ–å¤§é‡å†…èšçŠ¶æ€çš„å¤æ‚é€šç”¨é€»è¾‘ï¼Œæ¯”å¦‚ monaco-editorï¼‰
```

# 3. ç²¾è¯»

å†æ¬¡å¼ºè°ƒï¼Œä¸€ä¸ªæœ‰å¼¹æ€§çš„ç»„ä»¶éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ 4 ä¸ªåŸåˆ™ï¼š

1. **ä¸è¦é˜»å¡æ•°æ®æµã€‚**
2. **æ—¶åˆ»å‡†å¤‡å¥½æ¸²æŸ“ã€‚**
3. **ä¸è¦æœ‰å•ä¾‹ç»„ä»¶ã€‚**
4. **éš”ç¦»æœ¬åœ°çŠ¶æ€ã€‚**

æƒ³è¦éµå¾ªè¿™äº›è§„åˆ™çœ‹ä¸Šå»ä¹Ÿä¸éš¾ï¼Œä½†å®è·µè¿‡ç¨‹ä¸­ä¼šé‡åˆ°ä¸å°‘é—®é¢˜ï¼Œç¬”è€…ä¸¾å‡ ä¸ªä¾‹å­ã€‚

## é¢‘ç¹ä¼ é€’å›è°ƒå‡½æ•°

Function Component ä¼šå¯¼è‡´ç»„ä»¶ç²’åº¦æ‹†åˆ†çš„æ¯”è¾ƒç»†ï¼Œåœ¨æé«˜å¯ç»´æŠ¤æ€§åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´å…¨å±€ `state` æˆä¸ºè¿‡å»ï¼Œä¸‹é¢çš„ä»£ç å¯èƒ½è®©ä½ è§‰å¾—åˆ«æ‰­ï¼š

```jsx
const App = memo(function App() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState("nick");

  return (
    <>
      <Count count={count} setCount={setCount}/>
      <Name name={name} setName={setName}/>
    </>
  );
});

const Count = memo(function Count(props) {
  return (
      <input value={props.count} onChange={pipeEvent(props.setCount)}>
  );
});

const Name = memo(function Name(props) {
  return (
  <input value={props.name} onChange={pipeEvent(props.setName)}>
  );
});
```

è™½ç„¶å°†å­ç»„ä»¶ `Count` ä¸ `Name` æ‹†åˆ†å‡ºæ¥ï¼Œé€»è¾‘æ›´åŠ è§£è€¦ï¼Œä½†å­ç»„ä»¶éœ€è¦æ›´æ–°çˆ¶ç»„ä»¶çš„çŠ¶æ€å°±å˜å¾—éº»çƒ¦ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å°†å‡½æ•°ä½œä¸ºå‚æ•°é€ä¼ ç»™å­ç»„ä»¶ã€‚

ä¸€ç§åŠæ³•æ˜¯å°†å‡½æ•°é€šè¿‡ `Context` ä¼ ç»™å­ç»„ä»¶ï¼š

```jsx
const SetCount = createContext(null)
const SetName = createContext(null)

const App = memo(function App() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState("nick");

  return (
    <SetCount.Provider value={setCount}>
      <SetName.Provider value={setName}>
        <Count count={count}/>
        <Name name={name}/>
      </SetName.Provider>
    </SetCount.Provider>
  );
});

const Count = memo(function Count(props) {
  const setCount = useContext(SetCount)
  return (
      <input value={props.count} onChange={pipeEvent(setCount)}>
  );
});

const Name = memo(function Name(props) {
  const setName = useContext(SetName)
  return (
  <input value={props.name} onChange={pipeEvent(setName)}>
  );
});
```

ä½†è¿™æ ·ä¼šå¯¼è‡´ `Provider` è¿‡äºè‡ƒè‚¿ï¼Œå› æ­¤å»ºè®®éƒ¨åˆ†ç»„ä»¶ä½¿ç”¨ `useReducer` æ›¿ä»£ `useState`ï¼Œå°†å‡½æ•°åˆå¹¶åˆ° `dispatch`ï¼š

```jsx
const AppDispatch = createContext(null)

class State = {
  count = 0
  name = 'nick'
}

function appReducer(state, action) {
  switch(action.type) {
    case 'setCount':
      return {
        ...state,
        count: action.value
      }
    case 'setName':
      return {
        ...state,
        name: action.value
      }
    default:
      return state
  }
}

const App = memo(function App() {
  const [state, dispatch] = useReducer(appReducer, new State())

  return (
    <AppDispatch.Provider value={dispatch}>
      <Count count={count}/>
      <Name name={name}/>
    </AppDispatch.Provider>
  );
});

const Count = memo(function Count(props) {
  const dispatch = useContext(AppDispatch)
  return (
      <input value={props.count} onChange={pipeEvent(value => dispatch({type: 'setCount', value}))}>
  );
});

const Name = memo(function Name(props) {
  const dispatch = useContext(AppDispatch)
  return (
  <input value={props.name} onChange={pipeEvent(pipeEvent(value => dispatch({type: 'setName', value})))}>
  );
});
```

å°†çŠ¶æ€èšåˆåˆ° `reducer` ä¸­ï¼Œè¿™æ ·ä¸€ä¸ª `ContextProvider` å°±èƒ½è§£å†³æ‰€æœ‰æ•°æ®å¤„ç†é—®é¢˜äº†ã€‚

> memo åŒ…è£¹çš„ç»„ä»¶ç±»ä¼¼ PureComponent æ•ˆæœã€‚

## useCallback å‚æ•°å˜åŒ–é¢‘ç¹

åœ¨ [ç²¾è¯»ã€ŠuseEffect å®Œå…¨æŒ‡å—ã€‹](https://github.com/dt-fe/weekly/blob/master/96.%E7%B2%BE%E8%AF%BB%E3%80%8AuseEffect%20%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E3%80%8B.md#%E5%A6%82%E6%9E%9C%E9%9D%9E%E8%A6%81%E6%8A%8A-function-%E5%86%99%E5%9C%A8-effect-%E5%A4%96%E9%9D%A2%E5%91%A2) æˆ‘ä»¬ä»‹ç»äº†åˆ©ç”¨ `useCallback` åˆ›å»ºä¸€ä¸ª Immutable çš„å‡½æ•°ï¼š

```jsx
function Form() {
  const [text, updateText] = useState("");

  const handleSubmit = useCallback(() => {
    const currentText = text;
    alert(currentText);
  }, [text]);

  return (
    <>
      <input value={text} onChange={e => updateText(e.target.value)} />
      <ExpensiveTree onSubmit={handleSubmit} />
    </>
  );
}
```

ä½†è¿™ä¸ªå‡½æ•°çš„ä¾èµ– `[text]` å˜åŒ–è¿‡äºé¢‘ç¹ï¼Œä»¥è‡³äºåœ¨æ¯ä¸ª `render` éƒ½ä¼šé‡æ–°ç”Ÿæˆ `handleSubmit` å‡½æ•°ï¼Œå¯¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ã€‚ä¸€ç§è§£å†³åŠæ³•æ˜¯åˆ©ç”¨ `Ref` è§„é¿è¿™ä¸ªé—®é¢˜ï¼š

```jsx
function Form() {
  const [text, updateText] = useState("");
  const textRef = useRef();

  useEffect(() => {
    textRef.current = text; // Write it to the ref
  });

  const handleSubmit = useCallback(() => {
    const currentText = textRef.current; // Read it from the ref
    alert(currentText);
  }, [textRef]); // Don't recreate handleSubmit like [text] would do

  return (
    <>
      <input value={text} onChange={e => updateText(e.target.value)} />
      <ExpensiveTree onSubmit={handleSubmit} />
    </>
  );
}
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†è¿™ä¸ªè¿‡ç¨‹å°è£…ä¸ºä¸€ä¸ªè‡ªå®šä¹‰ Hooksï¼Œè®©ä»£ç ç¨å¾®å¥½çœ‹äº›ï¼š

```jsx
function Form() {
  const [text, updateText] = useState("");
  // Will be memoized even if `text` changes:
  const handleSubmit = useEventCallback(() => {
    alert(text);
  }, [text]);

  return (
    <>
      <input value={text} onChange={e => updateText(e.target.value)} />
      <ExpensiveTree onSubmit={handleSubmit} />
    </>
  );
}

function useEventCallback(fn, dependencies) {
  const ref = useRef(() => {
    throw new Error("Cannot call an event handler while rendering.");
  });

  useEffect(() => {
    ref.current = fn;
  }, [fn, ...dependencies]);

  return useCallback(() => {
    const fn = ref.current;
    return fn();
  }, [ref]);
}
```

> ä¸è¿‡è¿™ç§æ–¹æ¡ˆå¹¶ä¸ä¼˜é›…ï¼Œ[React è€ƒè™‘æä¾›ä¸€ä¸ªæ›´ä¼˜é›…çš„æ–¹æ¡ˆ](https://reactjs.org/docs/hooks-faq.html#how-to-read-an-often-changing-value-from-usecallback)ã€‚

## æœ‰å¯èƒ½è¢«æ»¥ç”¨çš„ useReducer

åœ¨ [ç²¾è¯»ã€ŠuseEffect å®Œå…¨æŒ‡å—ã€‹](https://github.com/dt-fe/weekly/blob/master/96.%E7%B2%BE%E8%AF%BB%E3%80%8AuseEffect%20%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E3%80%8B.md#%E5%B0%86%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%8A%A8%E4%BD%9C%E8%A7%A3%E8%80%A6) â€œå°†æ›´æ–°ä¸åŠ¨ä½œè§£è€¦â€ ä¸€èŠ‚é‡Œæåˆ°äº†ï¼Œåˆ©ç”¨ `useReducer` è§£å†³ â€œå‡½æ•°åŒæ—¶ä¾èµ–å¤šä¸ªå¤–éƒ¨å˜é‡çš„é—®é¢˜â€ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šè¿™ä¹ˆä½¿ç”¨ `useReducer`:

```tsx
const reducer = (state, action) => {
  switch (action.type) {
    case "increment":
      return { value: state.value + 1 };
    case "decrement":
      return { value: state.value - 1 };
    case "incrementAmount":
      return { value: state.value + action.amount };
    default:
      throw new Error();
  }
};

const [state, dispatch] = useReducer(reducer, { value: 0 });
```

ä½†å…¶å® `useReducer` å¯¹ `state` ä¸ `action` çš„å®šä¹‰å¯ä»¥å¾ˆéšæ„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `useReducer` æ‰“é€ ä¸€ä¸ª `useState`ã€‚

æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰å¤æ•° key çš„ `useState`:

```jsx
const [state, setState] = useState({ count: 0, name: "nick" });

// ä¿®æ”¹ count
setState(state => ({ ...state, count: 1 }));

// ä¿®æ”¹ name
setState(state => ({ ...state, name: "jack" }));
```

åˆ©ç”¨ `useReducer` å®ç°ç›¸ä¼¼çš„åŠŸèƒ½ï¼š

```jsx
function reducer(state, action) {
  return action(state);
}

const [state, dispatch] = useReducer(reducer, { count: 0, name: "nick" });

// ä¿®æ”¹ count
dispatch(state => ({ ...state, count: 1 }));

// ä¿®æ”¹ name
dispatch(state => ({ ...state, name: "jack" }));
```

å› æ­¤é’ˆå¯¹å¦‚ä¸Šæƒ…å†µï¼Œæˆ‘ä»¬å¯èƒ½æ»¥ç”¨äº† `useReducer`ï¼Œå»ºè®®ç›´æ¥ç”¨ `useState` ä»£æ›¿ã€‚

# 4. æ€»ç»“

æœ¬æ–‡æ€»ç»“äº†å…·æœ‰å¼¹æ€§çš„ç»„ä»¶çš„å››ä¸ªç‰¹æ€§ï¼šä¸è¦é˜»å¡æ•°æ®æµã€æ—¶åˆ»å‡†å¤‡å¥½æ¸²æŸ“ã€ä¸è¦æœ‰å•ä¾‹ç»„ä»¶ã€éš”ç¦»æœ¬åœ°çŠ¶æ€ã€‚

è¿™ä¸ªçº¦å®šå¯¹ä»£ç è´¨é‡å¾ˆé‡è¦ï¼Œè€Œä¸”éš¾ä»¥é€šè¿‡ lint è§„åˆ™æˆ–ç®€å•è‚‰çœ¼è§‚å¯ŸåŠ ä»¥è¯†åˆ«ï¼Œå› æ­¤æ¨å¹¿èµ·æ¥è¿˜æ˜¯æœ‰ä¸å°éš¾åº¦ã€‚

æ€»çš„æ¥è¯´ï¼ŒFunction Component å¸¦æ¥äº†æ›´ä¼˜é›…çš„ä»£ç ä½“éªŒï¼Œä½†æ˜¯å¯¹å›¢é˜Ÿåä½œçš„è¦æ±‚ä¹Ÿæ›´é«˜äº†ã€‚

> è®¨è®ºåœ°å€æ˜¯ï¼š[ç²¾è¯»ã€Šç¼–å†™æœ‰å¼¹æ€§çš„ç»„ä»¶ã€‹ Â· Issue #139 Â· dt-fe/weekly](https://github.com/dt-fe/weekly/issues/139)

**å¦‚æœä½ æƒ³å‚ä¸è®¨è®ºï¼Œè¯· [ç‚¹å‡»è¿™é‡Œ](https://github.com/dt-fe/weekly)ï¼Œæ¯å‘¨éƒ½æœ‰æ–°çš„ä¸»é¢˜ï¼Œå‘¨æœ«æˆ–å‘¨ä¸€å‘å¸ƒã€‚å‰ç«¯ç²¾è¯» - å¸®ä½ ç­›é€‰é è°±çš„å†…å®¹ã€‚**

> å…³æ³¨ **å‰ç«¯ç²¾è¯»å¾®ä¿¡å…¬ä¼—å·**

<img width=200 src="https://img.alicdn.com/tfs/TB165W0MCzqK1RjSZFLXXcn2XXa-258-258.jpg">

**special Sponsors**

- [DevOps å…¨æµç¨‹å¹³å°](https://e.coding.net/?utm_source=weekly)

> ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²åï¼ˆ[åˆ›æ„å…±äº« 3.0 è®¸å¯è¯](https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh)ï¼‰
